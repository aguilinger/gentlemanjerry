FROM alpine:3.8

ENV JDK_VERSION openjdk8
RUN apk update && apk add --no-cache bash curl "${JDK_VERSION}-jre-base" ruby java-cacerts

# Add extra certificates. Specifically, rapidssl is needed because it's used
# by Papertrail.
ENV LOCAL_TRUST_DIR /usr/local/share/ca-certificates
ADD rapidssl.crt "$LOCAL_TRUST_DIR/rapidssl.crt"
RUN update-ca-certificates

# LogStash will use JAVA_HOME
ENV JAVA_HOME /usr/lib/jvm/default-jvm/

# And actually ensure Java uses the system trustore java-cacerts creates
RUN JAVA_TRUSTSTORE=/usr/lib/jvm/java-1.8-openjdk/jre/lib/security/cacerts \
 && SYSTEM_TRUSTSTORE=/etc/ssl/certs/java/cacerts \
 && rm "$JAVA_TRUSTSTORE" \
 && ln -s "$SYSTEM_TRUSTSTORE" "$JAVA_TRUSTSTORE"

ENV LOGSTASH_VERSION 7.12.0

# Download the logstash tarball, verify its SHA against a golden SHA, extract it.
RUN curl -O "https://artifacts.elastic.co/downloads/logstash/logstash-${LOGSTASH_VERSION}-linux-x86_64.tar.gz" && \
    echo "ba32cb97e81cc3f4369c752b860aea7a85d212921954e5829f0b63526584d01c79731dd094905d91ed35f9887ae70bfffd5324b25dc3f23e60745462493e8195  logstash-${LOGSTASH_VERSION}-linux-x86_64.tar.gz" | sha512sum -c - && \
    tar zxf "logstash-${LOGSTASH_VERSION}-linux-x86_64.tar.gz" && \
    rm "logstash-${LOGSTASH_VERSION}-linux-x86_64.tar.gz"

# The Redis output is used with a local Redis, so we need to install it. We
# also pull coreutils, largely for convenience in our tests.
RUN apk add --no-cache coreutils redis

# Now, we need to install stunnel. It's only in the edge repo, and that package
# often breaks, so we install from source.
ADD bin/install-stunnel.sh install-stunnel.sh
RUN ./install-stunnel.sh

RUN apk add --no-cache git

# Install our special plugin implementations:
# - redis output implementation that supports scripts
# - http output implementation that puts @timestamp first if it's present
# - syslog output implementation that supports using the system's SSL keys and set SSL version
RUN GEMFILE="/logstash-${LOGSTASH_VERSION}/Gemfile" && \
    grep -v 'logstash-output-http' "$GEMFILE" > "${GEMFILE}.tmp" && \
    mv "${GEMFILE}.tmp" "$GEMFILE" && \
    grep -v 'logstash-output-redis' "$GEMFILE" > "${GEMFILE}.tmp" && \
    mv "${GEMFILE}.tmp" "$GEMFILE" && \
    echo "gem 'logstash-output-redis', :git => 'https://github.com/aptible/logstash-output-redis'," \
         ":ref=> 'f34391f'" >> "$GEMFILE" && \
    echo "gem 'logstash-output-http', :git => 'https://github.com/aptible/logstash-output-http'," \
         ":ref=> '096c302'" >> "$GEMFILE" && \
    echo "gem 'logstash-output-syslog', :git => 'https://github.com/aptible/logstash-output-syslog'," \
         ":branch => 'fa03421'" >> "$GEMFILE" && \
    "/logstash-${LOGSTASH_VERSION}/bin/logstash-plugin" install --no-verify

# Install elastcisearch plugin and plugins for some third-party destinations
RUN /logstash-${LOGSTASH_VERSION}/bin/logstash-plugin install logstash-output-elasticsearch && \
   /logstash-${LOGSTASH_VERSION}/bin/logstash-plugin install logstash-output-datadog_logs && \
   /logstash-${LOGSTASH_VERSION}/bin/logstash-plugin install logstash-output-sumologic

ADD templates/stunnel.conf /stunnel.conf
ADD templates/redis.conf.erb /redis.conf.erb
ADD templates/load-message.lua /load-message.lua
ADD templates/logstash.config.erb /logstash.config.erb
ADD templates/log4j.properties /log4j.properties
ADD bin/run-gentleman-jerry.sh run-gentleman-jerry.sh

# Install BATS (for tests)
RUN curl -sL https://github.com/sstephenson/bats/archive/master.zip > /tmp/bats.zip \
    && cd /tmp \
    && unzip -q bats.zip \
    && ./bats-master/install.sh /usr/local \
    # /usr/local/bin/bats should be a symlink, so make it happen.
    && ln -sf /usr/local/libexec/bats /usr/local/bin/bats \
    && rm -rf /tmp/bats*

# Run tests
ADD test /tmp/test
RUN /tmp/test/run_tests.sh

# A volume containing a certificate pair named jerry.key/jerry.crt must be mounted into
# this directory on the container.
VOLUME ["/tmp/certs"]

# Lumberjack
EXPOSE 5000
# Redis (used if the drain is a tail)
EXPOSE 6000

CMD ["/bin/bash", "run-gentleman-jerry.sh"]
